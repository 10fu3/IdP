<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
        <meta name="apiserver" th:content="${apiserver}">
        <meta name="redirect" th:content="${redirect}">
        <style>
            [v-cloak] {
              display: none;
            }
        </style>
    </head>
        <body>
    <div id="app">
        <v-app>

            <v-row justify="center" align-content="center">
                <v-col>
                    <div v-if="this.isSSO === false">
                        <v-card width="450px" class="mx-auto mt-5" elevation="12">
                            <v-card-title class="justify-center">
                                <v-img src="http://den3.net/wp-content/themes/den3HP/set/image/logo.png"></v-img>
                            </v-card-title>
                            <v-card-text>
                                <v-spacer />
                                <v-form>
                                    <v-text-field
                                        v-model="mail"
                                        label="E-mail address"
                                        prepend-icon="mdi-account-circle"
                                    />
                                </v-form>
                                <v-form>
                                    <v-text-field
                                        v-model="pass"
                                        type="Password"
                                        label="Password"
                                        prepend-icon="mdi-lock"
                                    />
                                </v-form>
                            </v-card-text>
                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-btn block color="info" @click="login">ログイン</v-btn>
                            </v-card-actions>
                            <!-- <v-card-actions>
                                <v-btn block color="success">新規登録</v-btn>
                            </v-card-actions> -->
                        </v-card>
                    </div>
                    <div v-else>
                        <v-card width="450px" class="mx-auto mt-5" elevation="12">
                            <v-card-title class="justify-center">
                                <v-img src="http://den3.net/wp-content/themes/den3HP/set/image/logo.png"></v-img>
                            </v-card-title>
                            <v-card-text>
                                <v-layout justify-center>
                                    <v-avatar class="justify-center" size="110">
                                        <img v-bind:src="usericon">
                                    </v-avatar>
                                </v-layout>
                                <h2 style="text-align: center">{{ username }}として</h2>
                                <h2 style="text-align: center">ログインします</h2>
                            </v-card-text>
                            <v-divider></v-divider>
                            <v-card-actions>
                                <v-btn block color="info" @click="login">ログイン</v-btn>
                            </v-card-actions>
                            <v-card-actions>
                                <v-btn block color="success">違うアカウントでログインする</v-btn>
                            </v-card-actions>
                        </v-card>
                    </div>
                </v-col>
            </v-row>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data: function () {
                return {
                    apiserver: '',
                    redirect: '',
                    isSSO: false,
                    mail: '',
                    pass: '',
                    username: '',
                    usericon: ''
                };
            },
            created: function () {
                this.apiserver = document.getElementsByName('apiserver')[0].getAttribute('content');
                this.redirect = document.getElementsByName('redirect')[0].getAttribute('content');

                if(localStorage.getItem('authorization')){
                    let response = fetch('http://localhost/api/v1/account/token', { 
                        method: 'get',
                        headers: new Headers({
                            'Authorization': localStorage.getItem('authorization'), 
                        })
                    });
                    response.then(r=>{
                        if(r.ok){
                            this.isSSO = true;
                            fetch('http://localhost/api/v1/account/profile', { 
                                method: 'get',
                                headers: new Headers({
                                    'Authorization': localStorage.getItem('authorization'), 
                                }),
                            }).then(d=>d.json()).then(profile=>{
                                this.usericon = profile.icon;
                                this.username = profile.nick;
                            });
                        }
                    });
                }
            },
            methods: {
                login: function () {
                    if(!this.isSSO){

                        fetch('http://localhost/api/v1/account/login', { 
                            method: 'post',
                            headers: {
                                'Content-Type': 'text/plain;charset=UTF-8'
                            },
                            body: JSON.stringify({
                                    "mail": this.mail,
                                    "pass": this.pass
                                }
                            )
                        }).then(d=>d.json()).then(j=>{
                            localStorage.setItem("authorization",j.authorization);
                            if(this.redirect != null){
                                location.href = this.redirect;
                                console.log(this.redirect);
                            }else{
                                
                            }
                        });
                    }else{
                        if(this.redirect != null){
                            location.href = this.redirect;
                        }
                    }
                }
            }
        })
      </script>
    </body>
</html>
